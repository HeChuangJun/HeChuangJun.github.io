import{_ as t}from"./plugin-vue_export-helper-DlAUqK2U.js";import{r as p,o as e,c,a as n,b as a,d as o,e as l}from"./app-7KT7HDzT.js";const i={},u=n("h2",{id:"渠道数据处理模块",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#渠道数据处理模块"},[n("span",null,"渠道数据处理模块")])],-1),k=n("strong",null,"负责第三方支付渠道对账文件的下载，解析，存储数据到数据库",-1),r=n("br",null,null,-1),d={href:"https://api.mch.weixin.qq.com/pay/downloadbill",target:"_blank",rel:"noopener noreferrer"},m=l(`<p>格式：支付宝cv、微信txt、xml、xls<br> 根据渠道特性、对账文件格式实现下载与解析接接口<br> 需要提取的信息:</p><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="language-text"><code>商户号、商户订单号、渠道流水号、交易日期、金额、手续费、退款原订单号、退款金额
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>同一渠道多个商户号多份对账文件<br> 网络异常导致数据不完整，对账文件重复下载<br> 每个渠道下载文件时间不一样</p><h2 id="数据处理模块" tabindex="-1"><a class="header-anchor" href="#数据处理模块"><span>数据处理模块</span></a></h2><p>提取前一日本地支付成功的流水数据和上一模块入库对账单的流水数据<br> 为了减少数据库的压力，流水数据只要包括交易时间，金额，交易订单号，渠道返回流水号等必要字段<br> 最好用备库查询。数据量大的情况下会拖慢主库，影响在线的支付交易</p><h2 id="数据核对模块" tabindex="-1"><a class="header-anchor" href="#数据核对模块"><span>数据核对模块</span></a></h2><details><summary>本端与对端数据核对订单号与金额，记录本端的差异数据</summary><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">//获取某一渠道本地支付数据</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LocalDataDT0</span><span class="token punctuation">&gt;</span></span>localDatalist<span class="token operator">=</span> <span class="token function">getLocalPayData</span><span class="token punctuation">(</span><span class="token string">&quot;支付渠道编号&quot;</span>，<span class="token string">&quot;账期&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//获取某一渠道对账单数据</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChannelDataDTO</span><span class="token punctuation">&gt;</span></span> channelDataList<span class="token operator">=</span> <span class="token function">getChannelPayData</span><span class="token punctuation">(</span><span class="token string">&quot;支付渠道编号&quot;</span>，<span class="token string">&quot;账期&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span>string<span class="token punctuation">,</span> <span class="token class-name">LocalDataDTO</span><span class="token punctuation">&gt;</span></span> localDataMaplocalDataList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>collectors<span class="token punctuation">.</span><span class="token function">toMap</span><span class="token punctuation">(</span>localData<span class="token operator">-&gt;</span> localData<span class="token punctuation">.</span><span class="token function">getorderNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span>localData<span class="token punctuation">.</span><span class="token function">getAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span>，<span class="token number">00</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">ChannelDataDTO</span><span class="token punctuation">&gt;</span></span> channelDataMapchannelDataList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toMap</span><span class="token punctuation">(</span>channelData<span class="token operator">-&gt;</span> channelData<span class="token punctuation">.</span><span class="token function">getOrderNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span>channelData<span class="token punctuation">.</span><span class="token function">getAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span>，<span class="token number">0</span>o<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LocalDataDTO</span><span class="token punctuation">&gt;</span></span>localDiffDetails <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//用本地账单数据的键值逐笔核对</span>
<span class="token class-name">LocalDataMap</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>localDataDTO<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>channelDataMap<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    channelDataMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">//渠道账单数据不包含本地数据键值</span>
    localDiffDetails<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>localDataDTO<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//若 channelDataMap 里面还有元素将其放入 channelDiffDataList</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>channelDataDTO<span class="token punctuation">&gt;</span></span> channelDiffDatalist <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>channelDataMap<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//记录差异数据</span>
<span class="token function">recordDiffData</span><span class="token punctuation">(</span>localDiffDetails<span class="token punctuation">,</span> channelDiffDataList<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><h2 id="差异数据处理模块" tabindex="-1"><a class="header-anchor" href="#差异数据处理模块"><span>差异数据处理模块</span></a></h2><p>数据核对模块可能产生三类差异数据<br> 金额不一致（人工判断）<br> 本端多账：本端数据存在，对端数据不存在<br> 存在跨日情况：对账文件缺少跨日订单，本端T日数据存在夸日订单。可以将这笔数据挂账，T+1工作对账时账单会相应多出数据，产生对端多账的差异数据。然后差异处理模块将前几日差异数据都提取出来，核对本端多账数据与对端多账数据。若核对一致，将两笔差异状态都更新成处理完成。若无剩余差异数据，当天账单平账</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">int</span> range <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>
<span class="token comment">//查询对账日期到range天差异记录 包括local和非local</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DiffPayData</span><span class="token punctuation">&gt;</span></span> allDiffDatas <span class="token operator">=</span> <span class="token function">queryDiffDatas</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>range<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//本端多账</span>
<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">DiffPayData</span><span class="token punctuation">&gt;</span></span> localDiffDatas <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//对端多账</span>
<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">DiffPayData</span><span class="token punctuation">&gt;</span></span> remoteDiffDatas <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span>◇<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//根据类型分为本端差异数据与对端差异数据</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">DiffPayData</span> diffData <span class="token operator">:</span>allDiffDatas<span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token string">&quot;local&quot;</span><span class="token punctuation">.</span><span class="token function">equalsIgnorecase</span><span class="token punctuation">(</span>diffData<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    localDiffDatas<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>diffData<span class="token punctuation">.</span><span class="token function">getOrderNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span> diffData<span class="token punctuation">.</span><span class="token function">getAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> diffData<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
    remoteDiffDatas<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>diffData<span class="token punctuation">.</span><span class="token function">getOrderNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span> diffData<span class="token punctuation">.</span><span class="token function">getAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> diffData<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>  
<span class="token comment">//核对上的差异数据</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DiffPayData</span><span class="token punctuation">&gt;</span></span> checkSucessDatas <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Arraylist</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>核对失败的差异数据
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DiffPayData</span><span class="token punctuation">&gt;</span></span> checkFailedDatas <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
localDiffDatas<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>diffPayData<span class="token punctuation">)</span><span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">//本端多账与对端多账键值相等</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>remoteDiffDatas<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    checkSucessDatas<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>remoteDiffDatas<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    checkSucessDatas<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>diffPayData<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    checkFailedDatas<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>diffPayData<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
checkFailedDatas<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>remoteDiffDatas<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//将成功对平的差异账状态修改为处理成功</span>
<span class="token function">updateSuccessDiffData</span><span class="token punctuation">(</span>checkSucessDatas<span class="token punctuation">)</span><span class="token operator">:</span>
<span class="token comment">//判断平账</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>checkFailedDatas<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;不平账&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;平账&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对端多账：对端数据存在，本端数据不存在<br> 测试、生产环境共用第三方渠道，测试环境订单出现在对账单中。忽略即可<br> 本端存在成功状态的订单。调用第三方渠道提查询订单状态接口。成功则更新订单状态，然后将差异数据状态更改为处理成功。最后重新对账</p>`,11);function v(f,D){const s=p("ExternalLinkIcon");return e(),c("div",null,[u,n("p",null,[k,r,a(" 定时在支付渠道网站（"),n("a",d,[a("微信支付宝"),o(s)]),a("，ntnstqryx招行）调用下载对账文件接口下载对账文件（SFTP）")]),m])}const h=t(i,[["render",v],["__file","reconciliationsystem.html.vue"]]),y=JSON.parse('{"path":"/interview/scenedesign/reconciliationsystem.html","title":"对账系统设计","lang":"zh-CN","frontmatter":{"title":"对账系统设计","date":"2023-01-01T00:00:00.000Z","tags":"面试","categories":"面试","description":"渠道数据处理模块 负责第三方支付渠道对账文件的下载，解析，存储数据到数据库 定时在支付渠道网站（微信支付宝，ntnstqryx招行）调用下载对账文件接口下载对账文件（SFTP） 格式：支付宝cv、微信txt、xml、xls 根据渠道特性、对账文件格式实现下载与解析接接口 需要提取的信息: 同一渠道多个商户号多份对账文件 网络异常导致数据不完整，对账文件...","head":[["meta",{"property":"og:url","content":"https://javaguide.cn/interview/scenedesign/reconciliationsystem.html"}],["meta",{"property":"og:site_name","content":"JavaGuide"}],["meta",{"property":"og:title","content":"对账系统设计"}],["meta",{"property":"og:description","content":"渠道数据处理模块 负责第三方支付渠道对账文件的下载，解析，存储数据到数据库 定时在支付渠道网站（微信支付宝，ntnstqryx招行）调用下载对账文件接口下载对账文件（SFTP） 格式：支付宝cv、微信txt、xml、xls 根据渠道特性、对账文件格式实现下载与解析接接口 需要提取的信息: 同一渠道多个商户号多份对账文件 网络异常导致数据不完整，对账文件..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"article:author","content":"HeChuangJun"}],["meta",{"property":"article:published_time","content":"2023-01-01T00:00:00.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"对账系统设计\\",\\"image\\":[\\"\\"],\\"datePublished\\":\\"2023-01-01T00:00:00.000Z\\",\\"dateModified\\":null,\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"HeChuangJun\\",\\"url\\":\\"https://javaguide.cn/article/\\"}]}"]]},"headers":[{"level":2,"title":"渠道数据处理模块","slug":"渠道数据处理模块","link":"#渠道数据处理模块","children":[]},{"level":2,"title":"数据处理模块","slug":"数据处理模块","link":"#数据处理模块","children":[]},{"level":2,"title":"数据核对模块","slug":"数据核对模块","link":"#数据核对模块","children":[]},{"level":2,"title":"差异数据处理模块","slug":"差异数据处理模块","link":"#差异数据处理模块","children":[]}],"git":{"createdTime":null,"updatedTime":null,"contributors":[]},"readingTime":{"minutes":3.24,"words":972},"filePathRelative":"interview/scenedesign/reconciliationsystem.md","localizedDate":"2023年1月1日","excerpt":"<!-- more -->\\n<h2>渠道数据处理模块</h2>\\n<p><strong>负责第三方支付渠道对账文件的下载，解析，存储数据到数据库</strong><br>\\n定时在支付渠道网站（<a href=\\"https://api.mch.weixin.qq.com/pay/downloadbill\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">微信支付宝</a>，ntnstqryx招行）调用下载对账文件接口下载对账文件（SFTP）</p>\\n<p>格式：支付宝cv、微信txt、xml、xls<br>\\n根据渠道特性、对账文件格式实现下载与解析接接口<br>\\n需要提取的信息:</p>","autoDesc":true}');export{h as comp,y as data};
